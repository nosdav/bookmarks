<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Bookmark Manager</title>
    <link rel="stylesheet" href="./css/style.css" />
    <script type="application/ld+json" id="data">
      {
        "@context": "https://schema.org"
      }
    </script>
    <script type="module">
      // imports
      import { html, render, Component } from './js/spux.js'
      import './js/dior.js'

      // utils
      const getQueryStringValue = key => {
        const queryParams = new URLSearchParams(
          window.location.search.substring(1)
        )
        return queryParams.get(key)
      }

      // init
      const serverUrl =
        getQueryStringValue('storage') || 'https://nosdav.nostr.rocks'
      var userHex, filename, contentType, path
      var isJson = false

      async function generateHeader(pubkey) {
        const event = {
          kind: 27235,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['url', path]],
          content: ''
        }
        const signedEvent = await window.nostr.signEvent(event)
        console.log(signedEvent)
        console.log(JSON.stringify(signedEvent))
        console.log(btoa(JSON.stringify(signedEvent)))

        return `Nostr ${btoa(JSON.stringify(signedEvent))}`
      }

      // app
      class App extends Component {
        constructor() {
          super()
          this.state = {
            userHex: null,
            filename: null,
            contentType: null,
            path: null,
            isJson: false,
            bookmarks: []
          }
          this.login = this.login.bind(this)
          this.save = this.save.bind(this)
          this.add = this.add.bind(this)
          this.delete = this.delete.bind(this)
        }

        delete(bookmark) {
          console.log('delete', bookmark)
          var url = bookmark.url
          this.state.bookmarks = this.state.bookmarks.filter(
            bookmark => bookmark.url !== url
          )

          this.setState({ bookmarks: this.state.bookmarks })
          console.log(this.state.bookmarks)
          this.save()
        }

        add() {
          const url = document.getElementById('bookmark-input').value
          const bookmark = {
            id: Date.now(),
            url: url
          }
          this.state.bookmarks.push(bookmark)
          this.setState({ bookmarks: this.state.bookmarks })
          this.save()
        }

        async login() {
          userHex = await window.nostr.getPublicKey()
          console.log(`Logged in with public key: ${userHex}`)
          this.setState({ userHex })
          this.loadFile()
        }

        // Load the file content from the server
        async loadFile() {
          if (!userHex) {
            alert('Please login first')
            return
          }

          isJson = true
          filename = 'bookmarks.json'
          path = `${serverUrl}/${userHex}/${filename}`
          contentType = 'application/json'
          this.setState({ path })

          var authorization = await generateHeader(userHex)

          fetch(path, {
            headers: {
              Authorization: authorization
            }
          })
            .then(response => {
              if (response.status === 200) {
                return response.text()
              } else {
                throw new Error('Failed to load file content')
              }
            })
            .then(text => {
              this.setState({ bookmarks: JSON.parse(text) })
            })
            .catch(error => {
              console.error(error)
              fileContent.placeholder = 'Error loading file content'
            })
        }

        async save() {
          if (!userHex) {
            alert('Please login first')
            return
          }

          isJson = true
          filename = 'bookmarks.json'
          contentType = 'application/json'

          const text = JSON.stringify(this.state.bookmarks)

          var authorization = await generateHeader(userHex)

          fetch(`${serverUrl}/${userHex}/${filename}`, {
            method: 'PUT',
            body: text,
            headers: {
              Authorization: authorization,
              'Content-Type': contentType,
              'Content-Length': text.length
            }
          })
            .then(response => {
              if (response.status === 201) {
                console.log('File saved successfully')
              } else {
                throw new Error('Failed to save file')
              }
            })
            .catch(error => {
              console.error(error)
              alert('Error saving file')
            })
        }

        render() {
          const { userHex, filename, contentType, path, isJson } = this.state
          return html`
            <div class="container">
              <h1>Bookmark Manager</h1>
              <input
                type="text"
                id="bookmark-input"
                placeholder="Enter a new bookmark URL"
              />

              ${this.state.userHex
                ? html`
                    <button onClick="${this.add}" type="button">
                      Add Bookmark
                    </button>
                    <a target="_blank" href="${this.state.path}"
                      ><button type="submit">Download</button></a
                    >
                  `
                : html` <button id="login" onClick="${this.login}">
                    Login
                  </button>`}

              <ul id="bookmark-list">
                <hr />
                ${this.state.bookmarks.map(
                  bookmark => html`
                    <li>
                      <a target="_blank" href=${bookmark.url}
                        >${bookmark.url}</a
                      >
                      <button
                        onClick="${this.delete.bind(this, bookmark)}"
                        type="button"
                      >
                        Delete
                      </button>
                    </li>
                  `
                )}
              </ul>
            </div>
          `
        }
      }

      render(html` <${App} /> `, document.body)
    </script>
  </head>
  <body></body>
</html>
